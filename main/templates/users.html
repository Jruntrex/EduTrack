{% extends "base.html" %}
{% load journal_filters %}

{% block title %}–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏{% endblock %}

{% block header_title %}–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏{% endblock %}

{% block content %}
<div class="card-bento min-h-[600px]">
    <div class="flex justify-end items-center mb-8">
        <button onclick="toggleForm()"
            class="px-6 py-3 bg-blue-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg shadow-blue-200 hover:bg-blue-700 transform hover:-translate-y-0.5 transition-all">
            –î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        </button>
    </div>

    <!-- FILTERS TOOLBAR -->
    <div class="bg-gray-50/50 rounded-2xl p-6 mb-8 border border-gray-100">
        <form method="GET" action="{% url 'users_list' %}"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 items-end">
            <div class="flex flex-col gap-1.5">
                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">–ü–æ—à—É–∫</label>
                <input type="text" name="search" value="{{ request.GET.search }}" placeholder="–Ü–º'—è –∞–±–æ Email..."
                    class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-sm font-medium transition-all">
            </div>

            <div class="flex flex-col gap-1.5">
                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">–†–æ–ª—å</label>
                <select name="role"
                    class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-sm font-medium transition-all">
                    <option value="">–í—Å—ñ —Ä–æ–ª—ñ</option>
                    <option value="student" {% if request.GET.role|is_equal:'student' %}selected{% endif %}>–°—Ç—É–¥–µ–Ω—Ç–∏
                    </option>
                    <option value="teacher" {% if request.GET.role|is_equal:'teacher' %}selected{% endif %}>–í–∏–∫–ª–∞–¥–∞—á—ñ
                    </option>
                    <option value="admin" {% if request.GET.role|is_equal:'admin' %}selected{% endif %}>–ê–¥–º—ñ–Ω–∏</option>
                </select>
            </div>

            <div class="flex flex-col gap-1.5">
                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">–ì—Ä—É–ø–∞</label>
                <select name="group"
                    class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-sm font-medium transition-all">
                    <option value="">–í—Å—ñ –≥—Ä—É–ø–∏</option>
                    {% for g in groups %}
                    {% with group_id=g.id|stringformat:"s" %}
                    <option value="{{ g.id }}" {% if request.GET.group|is_equal:group_id %}selected{% endif %}>{{ g.name
                        }}</option>
                    {% endwith %}
                    {% endfor %}
                </select>
            </div>

            <div class="flex flex-col gap-1.5">
                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">–î–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞</label>
                <select name="subject"
                    class="w-full px-4 py-2 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-sm font-medium transition-all">
                    <option value="">–í—Å—ñ –ø—Ä–µ–¥–º–µ—Ç–∏</option>
                    {% for sub in all_subjects %}
                    {% with sub_id=sub.id|stringformat:"s" %}
                    <option value="{{ sub.id }}" {% if request.GET.subject|is_equal:sub_id %}selected{% endif %}>{{
                        sub.name }}</option>
                    {% endwith %}
                    {% endfor %}
                </select>
            </div>

            <div class="flex items-center gap-3">
                <button type="submit"
                    class="flex-grow px-6 py-2.5 bg-gray-900 text-white rounded-xl text-xs font-black uppercase tracking-widest hover:bg-black transition-all">–ó–Ω–∞–π—Ç–∏</button>
                <a href="{% url 'users_list' %}"
                    class="p-2.5 bg-white border border-gray-200 rounded-xl text-gray-400 hover:text-red-500 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </a>
            </div>
        </form>
    </div>

    <div id="addForm" class="hidden glass-panel bg-white/50 rounded-2xl p-6 mb-8 animate-slide-down" aria-hidden="true">
        <h4 class="text-xl font-bold text-dark mb-6">–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h4>
        <form method="POST" action="{% url 'users_list' %}" class="space-y-4">
            {% csrf_token %}
            <div class="space-y-1">
                <input type="text" name="full_name" placeholder="–ü–Ü–ë" required
                    class="w-full px-4 py-3 border border-tableBorder rounded-xl text-dark bg-white focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200">
            </div>
            <div class="space-y-1">
                <input type="email" name="email" placeholder="Email" required
                    class="w-full px-4 py-3 border border-tableBorder rounded-xl text-dark bg-white focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200">
            </div>
            <div class="space-y-1">
                <select name="role" required onchange="updateFormFields()"
                    class="role-select w-full px-4 py-3 border border-tableBorder rounded-xl text-dark bg-white focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200 cursor-pointer">
                    <option value="" disabled selected>–í–∏–±–µ—Ä—ñ—Ç—å —Ä–æ–ª—å</option>
                    <option value="admin">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    <option value="teacher">–í–∏–∫–ª–∞–¥–∞—á</option>
                    <option value="student">–°—Ç—É–¥–µ–Ω—Ç</option>
                </select>
            </div>
            <div class="space-y-1">
                <input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å" required
                    class="w-full px-4 py-3 border border-tableBorder rounded-xl text-dark bg-white focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200">
            </div>
            <div class="space-y-1 group-field" style="display: none;">
                <select name="group"
                    class="w-full px-4 py-3 border border-tableBorder rounded-xl text-dark bg-white focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200">
                    <option value="">–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É</option>
                    {% for group in groups %}
                    <option value="{{ group.pk }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="space-y-2 subjects-field" style="display: none;">
                <label class="font-medium text-dark">–ü—Ä–µ–¥–º–µ—Ç–∏ (–¥–ª—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤):</label>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                    {% for subject in all_subjects %}
                    <label class="flex items-center gap-2 p-2 rounded-lg hover:bg-primary/5 cursor-pointer">
                        <input type="checkbox" name="subjects" value="{{ subject.pk }}">
                        <span class="text-bodyText">{{ subject.name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="submit"
                    class="btn bg-primary text-white shadow-button hover:bg-blue-600 py-2 px-6">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button type="button" onclick="toggleForm()"
                    class="btn bg-gray-400 text-white py-2 px-6">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </form>
    </div>

    <div class="glass-panel shadow-sm rounded-3xl p-0 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="p-4 text-left text-xs font-bold text-gray-500 uppercase hidden xl:table-cell">ID</th>
                        <th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                        <th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">–†–æ–ª—å</th>
                        <th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">–ö–æ–Ω—Ç–∞–∫—Ç–∏</th>
                        <th class="p-4 text-left text-xs font-bold text-gray-500 uppercase hidden lg:table-cell">
                            –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è</th>
                        <th class="p-4 text-center text-xs font-bold text-gray-500 uppercase hidden lg:table-cell">
                            –°—Ç–∞—Ç—É—Å</th>
                        <th class="p-4 text-center text-xs font-bold text-gray-500 uppercase hidden xl:table-cell">
                            –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</th>
                        <th class="p-4 text-right text-xs font-bold text-gray-500 uppercase">–ö–µ—Ä—É–≤–∞–Ω–Ω—è</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for user in users %}
                    <tr class="hover:bg-blue-50/50 transition duration-150 group">
                        <td class="p-4 text-xs font-mono text-gray-400 hidden xl:table-cell">#{{ user.id }}</td>
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-black text-xs shadow-sm">
                                    {{ user.full_name|slice:":1" }}
                                </div>
                                <span class="text-sm font-bold text-gray-900">{{ user.full_name }}</span>
                            </div>
                        </td>
                        <td class="p-4">
                            {% if user.role == 'admin' %}
                            <span class="badge-pill bg-purple-50 text-purple-600">–ê–¥–º—ñ–Ω</span>
                            {% elif user.role == 'teacher' %}
                            <span class="badge-pill bg-blue-50 text-blue-600">–í–∏–∫–ª–∞–¥–∞—á</span>
                            {% else %}
                            <span class="badge-pill bg-green-50 text-green-600">–°—Ç—É–¥–µ–Ω—Ç</span>
                            {% endif %}
                        </td>
                        <td class="p-4 text-sm text-gray-500">{{ user.email }}</td>

                        <td class="p-4 text-sm hidden lg:table-cell">
                            {% if user.role == 'teacher' %}
                            {# –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –≤–∏–∫–ª–∞–¥–∞—á–∞ #}
                            {% with assignments=user.teachingassignment_set.all %}
                            {% if assignments %}
                            <div class="flex flex-wrap gap-1 max-w-[220px]"
                                title="{% for a in assignments %}{{ a.subject.name }}{% if not forloop.last %}, {% endif %}{% endfor %}">

                                {% for a in assignments %}
                                {% if forloop.counter <= 2 %} <span
                                    class="px-2 py-0.5 rounded-full bg-blue-50 text-blue-600 text-[11px] border border-blue-100 whitespace-nowrap">
                                    {{ a.subject.name }}
                                    </span>
                                    {% endif %}
                                    {% endfor %}

                                    {% if assignments|length > 2 %}
                                    <span class="text-primary font-bold cursor-help ml-1"
                                        title="–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ">...</span>
                                    {% endif %}
                            </div>
                            {% else %}
                            <span class="text-gray-400">‚Äî</span>
                            {% endif %}
                            {% endwith %}
                            {% elif user.role == 'student' %}
                            {% if user.group %}
                            <span class="text-sm text-gray-500">
                                –ì—Ä—É–ø–∞: {{ user.group.name }}
                            </span>
                            {% else %}
                            <span class="text-gray-400">–ì—Ä—É–ø–∞ –Ω–µ –≤–∫–∞–∑–∞–Ω–∞</span>
                            {% endif %}
                            {% else %}
                            <span class="text-gray-400">‚Äî</span>
                            {% endif %}
                        </td>

                        <td class="p-4 text-center hidden lg:table-cell">
                            {% if user.is_active %}
                            <span
                                class="inline-flex px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold">–ê–∫—Ç–∏–≤–Ω–∏–π</span>
                            {% else %}
                            <span
                                class="inline-flex px-2 py-1 rounded-full bg-red-100 text-red-700 text-xs font-bold">–ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π</span>
                            {% endif %}
                        </td>

                        <td class="p-4 text-center text-xs text-gray-400 hidden xl:table-cell">
                            {% if user.created_at %}
                            <span class="block font-medium text-gray-600">{{ user.created_at|date:"d.m.Y" }}</span>
                            <span class="text-gray-400">{{ user.created_at|date:"H:i" }}</span>
                            {% else %}
                            <span class="text-gray-300">‚Äî</span>
                            {% endif %}
                        </td>

                        <td class="p-4 text-right">
                            <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <a href="{% url 'user_edit' pk=user.pk %}"
                                    class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-5 h-5">
                                        <path
                                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </a>
                                <form method="POST" action="{% url 'user_delete' pk=user.pk %}" class="inline">
                                    {% csrf_token %}
                                    <button type="submit"
                                        onclick="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {{ user.full_name }}?')"
                                        class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-5 h-5">
                                            <path
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="p-12 text-center text-gray-400">
                            <div class="text-4xl mb-4 opacity-50">üë•</div>
                            <p class="font-bold text-xs uppercase tracking-widest">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    function toggleForm() {
        document.getElementById('addForm').classList.toggle('hidden');
    }

    function updateFormFields() {
        const role = document.querySelector('.role-select').value;
        document.querySelector('.group-field').style.display = (role === 'student') ? 'block' : 'none';
        document.querySelector('.subjects-field').style.display = (role === 'teacher') ? 'block' : 'none';
    }
</script>
{% endblock %}