{% extends "base.html" %}

{% load static %}
{% load math_filters %}
{% load journal_filters %}

{% block title %}Журнал викладача{% endblock %}

{% block header_title %}Журнал Викладача{% endblock %}

{% block content %}
<div class="glass-panel rounded-3xl p-8 mb-8" role="region" aria-label="Журнал викладача">
    <div class="glass-panel shadow-sm rounded-3xl p-6 mb-8 bg-white/80 border border-gray-100">
        <form method="GET" action="{% url 'teacher_journal' %}"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">

            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-gray-500 uppercase">Предмет</label>
                <select name="subject" onchange="this.form.submit()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary text-sm">
                    {% for s in subjects %}
                    {% with s_id=s.pk|stringformat:"s" %}
                    <option value="{{ s.pk }}" {% if request.GET.subject|is_equal:s_id %}selected{% endif %}>
                        {{ s.subject_name }}
                    </option>
                    {% endwith %}
                    {% endfor %}
                </select>
            </div>

            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-gray-500 uppercase">Група</label>
                <select name="group" onchange="this.form.submit()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary text-sm">
                    {% for g in groups %}
                    {% with g_id=g.pk|stringformat:"s" %}
                    <option value="{{ g.pk }}" {% if request.GET.group|is_equal:g_id %}selected{% endif %}>
                        {{ g.name }}
                    </option>
                    {% endwith %}
                    {% endfor %}
                </select>
            </div>

            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-gray-500 uppercase">Пошук студента</label>
                <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Прізвище ім'я..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary text-sm">
            </div>

            <div class="flex flex-row gap-4 items-end">
                <div class="flex flex-col gap-1 flex-grow">
                    <label class="text-xs font-bold text-gray-500 uppercase">Тиждень</label>
                    <div class="flex items-center gap-2 bg-gray-50 p-1 rounded-lg border border-gray-200">
                        <a href="{% url 'teacher_journal' %}?subject={{ request.GET.subject }}&group={{ request.GET.group }}&search={{ request.GET.search }}&week={{ week_shift|add:'-1' }}"
                            class="p-1.5 rounded bg-primary text-white hover:bg-blue-600 transition">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg>
                        </a>
                        <span class="text-xs font-bold text-gray-700 min-w-[70px] text-center">
                            {{ start_of_week|date:"d.m" }} - {{ end_of_week|date:"d.m" }}
                        </span>
                        <a href="{% url 'teacher_journal' %}?subject={{ request.GET.subject }}&group={{ request.GET.group }}&search={{ request.GET.search }}&week={{ week_shift|add:'1' }}"
                            class="p-1.5 rounded bg-primary text-white hover:bg-blue-600 transition">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    </div>
                </div>
                <button type="submit"
                    class="px-6 py-2 rounded-lg bg-primary text-white hover:bg-blue-700 shadow-md transition font-medium">
                    Знайти
                </button>
            </div>

            <input type="hidden" name="week" value="{{ week_shift }}">
        </form>

        {% if selected_assignment %}
        <div class="flex justify-start mt-4 border-t pt-4">
            <a href="{% url 'manage_evaluation_types' %}?assignment={{ selected_assignment.id }}"
                class="flex items-center gap-2 px-4 py-2 bg-secondary text-white rounded-xl hover:bg-orange-600 transition shadow-sm text-sm font-medium">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Налаштувати типи оцінювання
            </a>
        </div>
        {% endif %}
    </div>

    <div class="mt-6 overflow-x-auto rounded-xl border border-tableBorder bg-glass shadow-glass">
        <table id="teacher-journal" class="w-full border-collapse">
            <thead>
                <tr>
                    <th rowspan="2"
                        class="sticky left-0 z-30 bg-primary text-white p-3 text-left text-xs font-bold uppercase tracking-wider min-w-[4rem] border-r border-white/20">
                        #</th>
                    <th rowspan="2"
                        class="sticky left-16 z-30 bg-primary text-white p-3 text-left text-xs font-bold uppercase tracking-wider min-w-[150px] border-r border-white/20">
                        ПІБ Студента</th>

                    {% for header in lesson_headers %}
                    <th colspan="{{ header.lessons|length }}"
                        class="bg-primary text-white p-3 text-center text-xs font-bold uppercase tracking-wider border-r border-white/20 last:border-r-0">
                        {{ header.date_formatted }} ({{ header.date|date:"D" }})
                    </th>
                    {% empty %}
                    {% if students %}
                    <th colspan="99" class="bg-primary text-white p-3 text-center">Немає запланованих занять для цієї
                        групи/предмету.</th>
                    {% else %}
                    <th colspan="99" class="bg-primary text-white p-3 text-center">Оберіть предмет та групу.</th>
                    {% endif %}
                    {% endfor %}
                </tr>

                <tr>
                    {% for header in lesson_headers %}
                    {% for lesson in header.lessons %}
                    <th
                        class="sticky top-[3.5rem] z-20 bg-gray-100/90 text-dark p-2 text-center border-l border-white/50 first:border-l-0 min-w-[100px] h-full align-top">
                        <div class="flex flex-col h-full justify-between gap-1">
                            <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Пара {{
                                lesson.lesson_num }}</span>
                            <div class="py-1">
                                <span class="block text-xs font-bold text-primary leading-tight">
                                    {{ lesson.lesson_type|truncatechars:15 }}
                                </span>
                                {% if lesson.classroom %}
                                <span
                                    class="inline-block mt-1 px-1.5 py-0.5 rounded bg-accent/10 text-accent text-[9px] font-black uppercase tracking-tighter">
                                    {{ lesson.classroom.name }}
                                </span>
                                {% endif %}
                                {% if lesson.weight_percent %}
                                <span class="block text-[10px] font-medium text-accent mt-0.5">
                                    Вага: {{ lesson.weight_percent }}%
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </th>
                    {% endfor %}
                    {% endfor %}
                </tr>
            </thead>

            <tbody>
                {% for student in students %}
                <tr data-student="{{ student.full_name }}"
                    class="{% cycle 'bg-tableBgLight' 'bg-tableBgDark' %} hover:bg-primary/10 transition-colors duration-200 group">

                    <td
                        class="sticky left-0 z-10 p-4 font-medium text-dark border-b border-tableBorder shadow-[2px_0_5px_rgba(0,0,0,0.05)] {% cycle 'bg-tableBgLight' 'bg-tableBgDark' %} group-hover:bg-primary/10">
                        {{ forloop.counter }}</td>
                    <td
                        class="sticky left-16 z-10 p-4 font-medium text-dark border-b border-tableBorder shadow-[2px_0_5px_rgba(0,0,0,0.05)] {% cycle 'bg-tableBgLight' 'bg-tableBgDark' %} group-hover:bg-primary/10">
                        {{ student.full_name }}</td>

                    {% for header in lesson_headers %}
                    {% for lesson in header.lessons %}
                    {% with entry=journal_data|get_item:student.pk|get_item:header.date|get_item:lesson.lesson_num %}
                    <td class="text-center p-3 border border-tableBorder cursor-pointer transition-all duration-200 hover:bg-primary/10 hover:shadow-inner editable
                                        {% if entry and entry.is_grade %}bg-blue-500/5{% else %}bg-transparent{% endif %}"
                        data-student="{{ student.pk }}" data-date="{{ header.date|date:'Y-m-d' }}"
                        data-lesson="{{ lesson.lesson_num }}" data-type="grade_or_att"
                        data-val="{{ entry.value|default:'—' }}">

                        {% if entry %}
                        {% with display_value=entry.get_display_value %}
                        <span class="font-bold 
                                                    {% if entry.is_grade and entry.value >= 10 %}text-accent
                                                    {% elif entry.is_grade and entry.value < 6 or entry.value == -1 %}text-error
                                                    {% elif entry.value == -2 or entry.value == -3 %}text-secondary
                                                    {% else %}text-dark{% endif %}">
                            {{ display_value }}
                        </span>
                        {% endwith %}
                        {% else %}
                        <span class="font-bold text-neutral">—</span>
                        {% endif %}
                    </td>
                    {% endwith %}
                    {% endfor %}
                    {% endfor %}

                </tr>
                {% empty %}
                <tr>
                    <td colspan="99" class="p-8 text-center text-neutral text-lg">Оберіть предмет та групу, або внесіть
                        дані розкладу.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-8 flex justify-end">
        <p id="status" class="hidden text-sm font-medium mr-4 flex items-center">Збереження імітується...</p>
        <button id="saveBtn"
            class="btn bg-primary text-white shadow-button hover:bg-blue-600 hover:shadow-button-hover flex items-center gap-2">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Зберегти всі зміни
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    $(document).ready(function () {
        const status = $('#status');

        const gradeOptions = [
            { value: '—', label: '— (Очистити)', type: 'neutral' },
            { value: '-1', label: 'Н (Неявка)', type: 'fail' },
            { value: '-2', label: 'ДЛ (Д/л, оплач.)', type: 'paid' },
            { value: '-3', label: 'ПП (Поважна)', type: 'paid' },
            { value: 12, label: '12 (Відм.)', type: 'excellent' },
            { value: 11, label: '11', type: 'excellent' },
            { value: 10, label: '10', type: 'excellent' },
            { value: 9, label: '9 (Добре)', type: 'good' },
            { value: 8, label: '8', type: 'good' },
            { value: 7, label: '7', type: 'good' },
            { value: 6, label: '6 (Задов.)', type: 'satisfactory' },
            { value: 5, label: '5 (Незадов.)', type: 'fail' },
            { value: 4, label: '4', type: 'fail' },
            { value: 3, label: '3', type: 'fail' },
            { value: 2, label: '2', type: 'fail' },
            { value: 1, label: '1', type: 'fail' },
        ].sort((a, b) => {
            if (a.value < 0 && b.value >= 0) return -1;
            if (a.value >= 0 && b.value < 0) return 1;
            return b.value - a.value;
        });

        $('#teacher-journal').on('click', '.editable', function () {
            const cell = $(this);
            if (cell.find('select, input').length > 0) return;

            const currentValue = cell.data('val');
            const isGrade = currentValue > 0 || (currentValue > 0).toString() === 'true';

            let elementToFocus;

            if (isGrade) {
                let inputElement = `<input type="text" value="${currentValue}" class="input-journal-grade" placeholder="1-12" maxlength="3">`;
                cell.html(inputElement);
                elementToFocus = cell.find('input').first();

                elementToFocus.on('blur change keydown', function (e) {
                    if (e.type === 'keydown' && e.key !== 'Enter' && e.key !== 'Tab') return;
                    formatAndSaveInput(cell, $(this));
                });
            } else {
                let optionsHtml = gradeOptions.map(option => {
                    const selected = option.value.toString() === currentValue.toString() ? 'selected' : '';
                    return `<option value="${option.value}" data-type="${option.type}" ${selected}>${option.label}</option>`;
                }).join('');

                let selectElement = `<select class="input-journal-select">${optionsHtml}</select>`;
                cell.html(selectElement);
                elementToFocus = cell.find('select').first();

                elementToFocus.on('change blur', function (e) {
                    formatAndSaveSelect(cell, $(this));
                });
            }

            elementToFocus.focus();
        });

        const formatAndSaveInput = function (cell, input) {
            let newValue = input.val().trim().toUpperCase();
            let displayText = newValue;
            let textClass = 'text-dark';
            let finalValue = newValue;

            if (!newValue) {
                displayText = '—';
                textClass = 'attendance-neutral';
                finalValue = '—';
            } else if (newValue >= 1 && newValue <= 12) {
                displayText = newValue;
                finalValue = parseInt(newValue);
                if (finalValue >= 10) textClass = 'grade-excellent';
                else if (finalValue < 6) textClass = 'grade-fail';
                else if (finalValue >= 7 && finalValue <= 9) textClass = 'grade-good';
                else if (finalValue == 6) textClass = 'grade-satisfactory';
            } else {
                displayText = '—';
                textClass = 'attendance-neutral';
                finalValue = '—';
            }

            cell.html(`<span class="font-bold ${textClass}">${displayText}</span>`);
            cell.data('val', finalValue);
        };

        const formatAndSaveSelect = function (cell, select) {
            const selectedOption = select.find('option:selected');
            const newValue = selectedOption.val();
            const displayText = selectedOption.text().split(' ')[0];
            const type = selectedOption.data('type');

            let textClass = 'text-dark';
            if (type) textClass = `grade-${type} attendance-${type}`;

            let finalValue = newValue === '—' ? '—' : parseInt(newValue);

            cell.html(`<span class="font-bold ${textClass}">${displayText}</span>`);
            cell.data('val', finalValue);
        };

        $('#saveBtn').on('click', function () {
            const status = $('#status');
            const changes = [];
            const selectedSubjectId = $('select[name="subject"]').val();

            $('#teacher-journal .editable').each(function () {
                const cell = $(this);
                const value = cell.data('val');

                if (value && value !== '—') {
                    changes.push({
                        'student_pk': cell.data('student'),
                        'date': cell.data('date'),
                        'lesson_num': cell.data('lesson'),
                        'value': value,
                        'subject_id': selectedSubjectId,
                    });
                } else if (value === '—' && cell.find('span').text().trim() !== '—') {
                    changes.push({
                        'student_pk': cell.data('student'),
                        'date': cell.data('date'),
                        'lesson_num': cell.data('lesson'),
                        'value': '—',
                        'subject_id': selectedSubjectId,
                    });
                }
            });

            if (changes.length === 0) {
                status.removeClass('hidden').text('Немає змін для збереження.').addClass('alert-info');
                setTimeout(() => status.addClass('hidden').removeClass('alert-info'), 2000);
                return;
            }

            status.removeClass('hidden').text('Збереження...').addClass('alert-info');

            fetch('{% url "save_journal_entries" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ changes: changes }),
            })
                .then(response => {
                    if (!response.ok) return response.json().then(errorData => { throw new Error(errorData.message || 'Помилка мережі.'); });
                    return response.json();
                })
                .then(response => {
                    status.text(response.message).removeClass('alert-info alert-error').addClass('alert-success');
                    setTimeout(() => window.location.reload(), 500);
                })
                .catch(error => {
                    status.text('Помилка: ' + error.message).removeClass('alert-info').addClass('alert-error');
                    setTimeout(() => status.addClass('hidden').removeClass('alert-error'), 8000);
                });
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}