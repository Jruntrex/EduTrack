{% extends "base.html" %}
{% load journal_filters %}

{% block title %}Конструктор розкладу - EduTrack{% endblock %}

{% block header_title %}Конструктор Розкладу{% endblock %}

{% block content %}
<div class="card-bento min-h-[600px]">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <div class="glass-panel shadow-sm rounded-3xl p-6 sticky top-6">
                <div class="mb-6">
                    <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2 block">Оберіть
                        групу</label>
                    <select id="groupSelect"
                        class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 text-sm font-medium transition-all">
                        <option value="">-- Виберіть групу --</option>
                        {% for g in groups %}
                        <option value="{{ g.id }}">{{ g.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="groupInfo" class="mb-6 p-4 bg-blue-50 border border-blue-100 rounded-2xl hidden">
                    <div id="groupInfoText" class="text-sm font-bold text-blue-600">
                        Оберіть групу для початку
                    </div>
                </div>

                <div id="autoSaveStatus" class="mb-6 text-sm font-bold"></div>

                <div class="space-y-3">
                    <button id="saveBtn"
                        class="w-full px-6 py-3 bg-blue-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg shadow-blue-200 hover:bg-blue-700 transform hover:-translate-y-0.5 transition-all">
                        Зберегти розклад
                    </button>
                    <button id="clearAllBtn"
                        class="w-full px-6 py-3 bg-white border border-gray-200 text-gray-700 rounded-2xl font-bold text-xs uppercase tracking-widest hover:bg-gray-50 transition-all">
                        Очистити все
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="lg:col-span-3">
            <div id="scheduleContainer" style="display: none;" class="space-y-8">
                {% for day_id, day_name in days %}
                <div class="glass-panel shadow-sm rounded-3xl p-6 overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-black text-gray-800">{{ day_name }}</h3>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full min-w-[800px]">
                            <thead class="bg-gray-50/50 border-b border-gray-100">
                                <tr>
                                    <th class="p-3 text-center text-[10px] font-black text-gray-400 uppercase w-10">№
                                    </th>
                                    <th class="p-3 text-left text-[10px] font-black text-gray-400 uppercase w-48">Час
                                        (Початок / Тривалість)</th>
                                    <th class="p-3 text-left text-[10px] font-black text-gray-400 uppercase">Предмет
                                    </th>
                                    <th class="p-3 text-left text-[10px] font-black text-gray-400 uppercase w-40">
                                        Викладач</th>
                                    <th class="p-3 text-center text-[10px] font-black text-gray-400 uppercase w-20">Ауд.
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                {% for num in lesson_numbers %}
                                <tr class="hover:bg-blue-50/30 transition-colors lesson-row" data-day="{{ day_id }}"
                                    data-lesson="{{ num }}">
                                    <!-- Number -->
                                    <td class="p-3 text-center align-top pt-4">
                                        <div class="font-black text-gray-900">{{ num }}</div>
                                    </td>

                                    <!-- Time & Duration -->
                                    <td class="p-3 align-top">
                                        <div class="flex flex-col gap-2">
                                            <div class="flex items-center gap-2">
                                                <input type="time"
                                                    class="lesson-start-time w-24 px-2 py-1 bg-gray-50 border border-gray-200 rounded-lg text-xs font-bold text-gray-700"
                                                    value="{% with times=lesson_times|get_item:num %}{{ times.0 }}{% endwith %}">
                                                <span class="text-gray-400 text-xs">-</span>
                                                <span
                                                    class="lesson-end-time text-xs font-bold text-gray-500">--:--</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <select
                                                    class="lesson-duration w-24 px-2 py-1 bg-gray-50 border border-gray-200 rounded-lg text-xs text-gray-600">
                                                    <option value="45">45 хв</option>
                                                    <option value="50">50 хв</option>
                                                    <option value="80">80 хв</option>
                                                    <option value="90" selected>90 хв</option>
                                                    <option value="custom">Інше...</option>
                                                </select>
                                                <input type="number"
                                                    class="lesson-duration-custom w-16 px-2 py-1 bg-gray-50 border border-gray-200 rounded-lg text-xs hidden"
                                                    placeholder="Хв">
                                            </div>
                                            <div class="time-error text-[10px] text-red-500 font-bold hidden"></div>
                                        </div>
                                    </td>

                                    <!-- Subject Select -->
                                    <td class="p-3 align-top pt-3">
                                        <select
                                            class="lesson-subject w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all text-gray-700">
                                            <option value="">--</option>
                                            {% for item in subject_data %}
                                            <option value="{{ item.id }}" data-teacher-id="{{ item.teacher_id }}"
                                                data-teacher-name="{{ item.teacher_name }}">
                                                {{ item.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </td>

                                    <!-- Teacher (Auto-filled) -->
                                    <td class="p-3 align-top pt-3">
                                        <input type="text" readonly
                                            class="lesson-teacher w-full px-3 py-2 bg-transparent border-none text-xs text-gray-500 font-medium focus:ring-0 cursor-default"
                                            placeholder="Автоматично">
                                        <input type="hidden" class="lesson-teacher-id">
                                    </td>

                                    <!-- Classroom -->
                                    <td class="p-3 align-top pt-3">
                                        <input type="text"
                                            class="lesson-classroom w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all text-center"
                                            placeholder="...">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Empty State -->
            <div id="emptyState"
                class="flex flex-col items-center justify-center py-20 text-center glass-panel rounded-3xl mt-8"
                style="display: none;">
                <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Розклад не відображається</h3>
                <p class="text-gray-500 max-w-sm">Будь ласка, оберіть групу зі списку ліворуч, щоб почати редагування
                    розкладу.</p>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const elements = {
            groupSelect: document.getElementById('groupSelect'),
            scheduleContainer: document.getElementById('scheduleContainer'),
            emptyState: document.getElementById('emptyState'),
            saveBtn: document.getElementById('saveBtn'),
            clearAllBtn: document.getElementById('clearAllBtn'),
            autoSaveStatus: document.getElementById('autoSaveStatus'),
            groupInfo: document.getElementById('groupInfo'),
            groupInfoText: document.getElementById('groupInfoText')
        };

        // This will hold the FULL schedule data for all groups loaded from server
        let allScheduleData = {};
        try {
            const dataEl = document.getElementById('schedule-data');
            if (dataEl) {
                allScheduleData = JSON.parse(dataEl.textContent);
            }
        } catch (e) {
            console.error("Error parsing schedule data", e);
        }

        let state = {
            currentGroup: null,
            modified: false
        };

        // --- Event Listeners ---

        elements.groupSelect.addEventListener('change', function () {
            const groupId = this.value;
            state.currentGroup = groupId;

            if (groupId) {
                elements.scheduleContainer.style.display = 'block';
                elements.emptyState.style.display = 'none';
                elements.groupInfo.classList.remove('hidden');
                elements.groupInfoText.textContent = `Редагування: ${this.options[this.selectedIndex].text}`;

                loadScheduleForGroup(groupId);
                state.modified = false;
                updateStatus('');
                // Validate all times after loading
                elements.scheduleContainer.querySelectorAll('.glass-panel').forEach(dayPanel => validateDayTimes(dayPanel));
            } else {
                elements.scheduleContainer.style.display = 'none';
                elements.emptyState.style.display = 'flex';
                elements.groupInfo.classList.add('hidden');
            }
        });

        // Delegate events
        elements.scheduleContainer.addEventListener('change', function (e) {
            const target = e.target;

            if (target.classList.contains('lesson-subject')) {
                handleSubjectChange(target);
                markModified();
            } else if (target.classList.contains('lesson-classroom')) {
                markModified();
            } else if (target.classList.contains('lesson-start-time') ||
                target.classList.contains('lesson-duration') ||
                target.classList.contains('lesson-duration-custom')) {

                if (target.classList.contains('lesson-duration')) {
                    const row = target.closest('tr');
                    const customInput = row.querySelector('.lesson-duration-custom');
                    if (target.value === 'custom') {
                        customInput.classList.remove('hidden');
                        customInput.focus();
                    } else {
                        customInput.classList.add('hidden');
                    }
                }

                updateEndTime(target.closest('tr'));
                validateDayTimes(target.closest('.glass-panel')); // Validate the whole day
                markModified();
            }
        });

        // Input event for real-time validation feedback (optional)
        elements.scheduleContainer.addEventListener('input', function (e) {
            if (e.target.classList.contains('lesson-duration-custom')) {
                updateEndTime(e.target.closest('tr'));
                validateDayTimes(e.target.closest('.glass-panel'));
                markModified();
            }
        });

        elements.saveBtn.addEventListener('click', saveSchedule);

        elements.clearAllBtn.addEventListener('click', function () {
            if (!state.currentGroup) return;
            if (!confirm('Ви впевнені? Це видалить весь розклад для цієї групи.')) return;

            const inputs = elements.scheduleContainer.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.classList.contains('lesson-start-time') || input.classList.contains('lesson-duration')) return;
                input.value = '';
            });
            elements.scheduleContainer.querySelectorAll('.lesson-subject').forEach(s => s.value = "");

            // Автоматично зберігаємо порожній розклад
            setTimeout(() => {
                saveSchedule();
            }, 100);
        });

        // --- Functions ---

        function updateEndTime(row) {
            const startTimeInput = row.querySelector('.lesson-start-time');
            const durationSelect = row.querySelector('.lesson-duration');
            const durationCustom = row.querySelector('.lesson-duration-custom');
            const endTimeSpan = row.querySelector('.lesson-end-time');

            if (!startTimeInput.value) {
                endTimeSpan.textContent = "--:--";
                return;
            }

            let duration = parseInt(durationSelect.value);
            if (isNaN(duration) || durationSelect.value === 'custom') {
                duration = parseInt(durationCustom.value) || 0;
            }

            const [hours, minutes] = startTimeInput.value.split(':').map(Number);
            const date = new Date();
            date.setHours(hours, minutes + duration);

            const endHours = String(date.getHours()).padStart(2, '0');
            const endMinutes = String(date.getMinutes()).padStart(2, '0');
            endTimeSpan.textContent = `${endHours}:${endMinutes}`;

            // Store calculated end time details on the row for validation
            row.dataset.endHours = endHours;
            row.dataset.endMinutes = endMinutes;
            row.dataset.totalMinutesEnd = hours * 60 + minutes + duration;
        }

        function validateDayTimes(dayPanel) {
            const rows = Array.from(dayPanel.querySelectorAll('.lesson-row'));
            let previousEndMinutes = -1; // time in minutes from midnight

            rows.forEach((row, index) => {
                const startTimeInput = row.querySelector('.lesson-start-time');
                const errorDiv = row.querySelector('.time-error');
                const subjectVal = row.querySelector('.lesson-subject').value;

                // Reset error
                errorDiv.textContent = '';
                errorDiv.classList.add('hidden');
                startTimeInput.classList.remove('border-red-500', 'text-red-500');

                if (!startTimeInput.value) return;

                const [hours, minutes] = startTimeInput.value.split(':').map(Number);
                const currentStartMinutes = hours * 60 + minutes;

                // Only validate if this row has a subject or we want strict time validation regardless
                // Let's validate strictly if previous lesson exists
                if (index > 0 && previousEndMinutes !== -1) {
                    const diff = currentStartMinutes - previousEndMinutes;
                    if (diff < 5) {
                        errorDiv.textContent = `Перерва < 5 хв! (${diff} хв)`;
                        errorDiv.classList.remove('hidden');
                        startTimeInput.classList.add('border-red-500', 'text-red-500');
                    }
                }

                // Update previous end for next iteration
                // We need to calculate this row's end time
                const durationSelect = row.querySelector('.lesson-duration');
                const durationCustom = row.querySelector('.lesson-duration-custom');
                let duration = parseInt(durationSelect.value);
                if (isNaN(duration) || durationSelect.value === 'custom') {
                    duration = parseInt(durationCustom.value) || 0;
                }

                // Only carry forward if this lesson actually exists/has duration
                if (duration > 0) {
                    previousEndMinutes = currentStartMinutes + duration;
                } else {
                    // If no valid duration, treat as if it doesn't exist for validation chain? 
                    // Or just use start time? safely ignore.
                }
            });
        }

        function handleSubjectChange(selectElement) {
            const row = selectElement.closest('tr');
            if (!row) return;

            const teacherInput = row.querySelector('.lesson-teacher');
            const teacherIdInput = row.querySelector('.lesson-teacher-id');
            const selectedOption = selectElement.options[selectElement.selectedIndex];

            if (selectedOption.value) {
                const teacherName = selectedOption.dataset.teacherName || '';
                const teacherId = selectedOption.dataset.teacherId || '';
                teacherInput.value = teacherName;
                teacherIdInput.value = teacherId;
            } else {
                teacherInput.value = '';
                teacherIdInput.value = '';
            }
        }

        function loadScheduleForGroup(groupId) {
            // 1. Reset all fields
            const allRows = elements.scheduleContainer.querySelectorAll('.lesson-row');
            allRows.forEach(row => {
                row.querySelector('.lesson-subject').value = '';
                row.querySelector('.lesson-teacher').value = '';
                row.querySelector('.lesson-teacher-id').value = '';
                row.querySelector('.lesson-classroom').value = '';
                // Don't reset time completely, revert to default attributes if needed, or keep last state
                // Actually, let's keep the backend provided default times as "base", but overwrite if data exists
            });

            // 2. Load data
            const groupData = allScheduleData[groupId];
            if (!groupData) {
                // If no data, ensure default times are calculated
                allRows.forEach(row => updateEndTime(row));
                return;
            };

            Object.keys(groupData).forEach(dayId => {
                const dayLessons = groupData[dayId];
                Object.keys(dayLessons).forEach(lessonNum => {
                    const lessonData = dayLessons[lessonNum];
                    const row = elements.scheduleContainer.querySelector(`.lesson-row[data-day="${dayId}"][data-lesson="${lessonNum}"]`);

                    if (row) {
                        // Subject
                        const subjectSelect = row.querySelector('.lesson-subject');
                        subjectSelect.value = lessonData.subject_id || '';

                        // Teacher
                        if (subjectSelect.value) {
                            const selectedOption = subjectSelect.querySelector(`option[value="${subjectSelect.value}"]`);
                            if (selectedOption) {
                                row.querySelector('.lesson-teacher').value = selectedOption.dataset.teacherName || '';
                                row.querySelector('.lesson-teacher-id').value = selectedOption.dataset.teacherId || '';
                            }
                        }

                        // Classroom
                        row.querySelector('.lesson-classroom').value = lessonData.classroom || '';

                        // Time
                        if (lessonData.start_time) {
                            row.querySelector('.lesson-start-time').value = lessonData.start_time;
                        }

                        // Duration
                        if (lessonData.duration) {
                            const duration = lessonData.duration;
                            const durationSelect = row.querySelector('.lesson-duration');
                            const customInput = row.querySelector('.lesson-duration-custom');

                            // Check if standard
                            const option = durationSelect.querySelector(`option[value="${duration}"]`);
                            if (option) {
                                durationSelect.value = duration;
                                customInput.classList.add('hidden');
                            } else {
                                durationSelect.value = 'custom';
                                customInput.value = duration;
                                customInput.classList.remove('hidden');
                            }
                        }

                        updateEndTime(row);
                    }
                });
            });

            // Re-validate visual state
            elements.scheduleContainer.querySelectorAll('.glass-panel').forEach(dayPanel => validateDayTimes(dayPanel));
        }

        function saveSchedule() {
            if (!state.currentGroup) return;

            updateStatus('Збереження...', 'blue');
            const scheduleToSave = {};

            const rows = elements.scheduleContainer.querySelectorAll('.lesson-row');
            rows.forEach(row => {
                const day = row.dataset.day;
                const lesson = row.dataset.lesson;
                const subjectId = row.querySelector('.lesson-subject').value;

                if (subjectId) {
                    if (!scheduleToSave[day]) scheduleToSave[day] = {};

                    const subjectSelect = row.querySelector('.lesson-subject');
                    const option = subjectSelect.options[subjectSelect.selectedIndex];
                    const teacherId = row.querySelector('.lesson-teacher-id').value;
                    const teacherName = row.querySelector('.lesson-teacher').value;
                    const classroom = row.querySelector('.lesson-classroom').value;

                    // Time Data
                    const startTime = row.querySelector('.lesson-start-time').value;
                    const durationSelect = row.querySelector('.lesson-duration');
                    let duration = parseInt(durationSelect.value);
                    if (isNaN(duration) || durationSelect.value === 'custom') {
                        duration = parseInt(row.querySelector('.lesson-duration-custom').value) || 90;
                    }

                    scheduleToSave[day][lesson] = {
                        subject_id: parseInt(subjectId),
                        subject_name: option.text.trim(),
                        teacher_id: teacherId ? parseInt(teacherId) : null,
                        teacher_name: teacherName,
                        start_time: startTime,
                        duration: duration,
                        classroom: classroom,
                    };
                }
            });

            fetch('{% url "save_schedule" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    group_id: parseInt(state.currentGroup),
                    schedule: scheduleToSave
                })
            })
                .then(r => r.json())
                .then(res => {
                    if (res.status === 'success') {
                        state.modified = false;
                        updateStatus('✓ Збережено успішно!', 'green');
                        allScheduleData[state.currentGroup] = scheduleToSave;
                    } else {
                        updateStatus('❌ Помилка: ' + res.message, 'red');
                    }
                })
                .catch(err => {
                    console.error(err);
                    updateStatus('❌ Помилка з’єднання', 'red');
                });
        }

        function markModified() {
            state.modified = true;
            updateStatus('⚠️ Є незбережені зміни', 'amber');
        }

        function updateStatus(msg, color = 'gray') {
            const colors = {
                'green': 'text-green-500',
                'red': 'text-red-500',
                'blue': 'text-blue-500',
                'amber': 'text-amber-500',
                'gray': 'text-gray-400'
            };
            elements.autoSaveStatus.textContent = msg;
            elements.autoSaveStatus.className = `mb-6 text-sm font-bold ${colors[color] || colors.gray}`;
        }

        // Initial init: Trigger empty state
        elements.groupSelect.value = "";
        elements.groupSelect.dispatchEvent(new Event('change'));
    });
</script>

{{ schedule_map|json_script:"schedule-data" }}
{% endblock %}